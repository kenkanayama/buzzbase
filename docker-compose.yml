# =============================================================================
# BuzzBase - Docker Compose (Development)
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Frontend (Vite + React)
  # ---------------------------------------------------------------------------
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: buzzbase-frontend
    ports:
      - "5173:5173"
    volumes:
      - ./frontend:/app
      - /app/node_modules  # node_modules を保護
    environment:
      - NODE_ENV=development
      - VITE_FIREBASE_API_KEY=${VITE_FIREBASE_API_KEY:-}
      - VITE_FIREBASE_AUTH_DOMAIN=${VITE_FIREBASE_AUTH_DOMAIN:-}
      - VITE_FIREBASE_PROJECT_ID=${VITE_FIREBASE_PROJECT_ID:-}
      - VITE_FIREBASE_STORAGE_BUCKET=${VITE_FIREBASE_STORAGE_BUCKET:-}
      - VITE_FIREBASE_MESSAGING_SENDER_ID=${VITE_FIREBASE_MESSAGING_SENDER_ID:-}
      - VITE_FIREBASE_APP_ID=${VITE_FIREBASE_APP_ID:-}
    stdin_open: true
    tty: true

  # ---------------------------------------------------------------------------
  # Firebase Emulator (オプション: ローカルでのテスト用)
  # ---------------------------------------------------------------------------
  firebase-emulator:
    image: node:20-alpine
    container_name: buzzbase-firebase-emulator
    ports:
      - "9099:9099"   # Auth Emulator
      - "8080:8080"   # Firestore Emulator
      - "4000:4000"   # Emulator UI
    volumes:
      - ./firebase:/app
    working_dir: /app
    command: >
      sh -c "
        npm install -g firebase-tools &&
        firebase emulators:start --only auth,firestore --project demo-buzzbase
      "
    profiles:
      - emulator  # `docker compose --profile emulator up` で起動

  # ---------------------------------------------------------------------------
  # Terraform (インフラ管理用)
  # ---------------------------------------------------------------------------
  terraform:
    build:
      context: .
      dockerfile: Dockerfile.terraform
    container_name: buzzbase-terraform
    volumes:
      - ./terraform:/terraform
      - ./gcp-service-account.json:/terraform/gcp-service-account.json:ro
    environment:
      - GOOGLE_APPLICATION_CREDENTIALS=/terraform/gcp-service-account.json
    working_dir: /terraform
    stdin_open: true
    tty: true
    profiles:
      - terraform  # `docker compose --profile terraform run --rm terraform <command>` で実行

# =============================================================================
# Networks
# =============================================================================
networks:
  default:
    name: buzzbase-network

