# BuzzBase 開発ロードマップ

> 最終更新日: 2025年12月24日

このドキュメントでは、今後実装予定の機能改善・追加について記載します。
開発順序を考慮した優先度順に記載しています。

---

## 目次

1. [Phase 1: デザイン統一](#phase-1-デザイン統一)
2. [Phase 2: データ未存在時のUI対応](#phase-2-データ未存在時のui対応)
3. [Phase 3: SNSアカウント未連携時の制御](#phase-3-snsアカウント未連携時の制御)
4. [Phase 4: PR投稿登録フロー（ステップ2）の改善](#phase-4-pr投稿登録フローステップ2の改善)
5. [Phase 5: 投稿一覧フィルタリング機能](#phase-5-投稿一覧フィルタリング機能)
6. [Phase 6: Instagramアクセストークン自動更新機能](#phase-6-instagramアクセストークン自動更新機能)
7. [Phase 7: バッチ処理による数値データ取得機能](#phase-7-バッチ処理による数値データ取得機能)
8. [検討事項・課題一覧](#検討事項課題一覧)

---

## Phase 1: デザイン統一

### 概要

ダッシュボードと「PR投稿を登録」画面のデザインを統一する。

### 現状

- ダッシュボードのヘッダーと下部は薄いグレー透過の背景を使用している
- 「PR投稿を登録」画面では異なるデザインになっている

### 対応内容

- [x] 「PR投稿を登録」画面のヘッダー・フッターを、ダッシュボードと同様の薄いグレー透過背景に統一する
- [x] 全画面で一貫したデザインシステムを適用

### 優先度

**高** - 他の機能開発前にUIの基盤を整えておく

---

## Phase 2: データ未存在時のUI対応

### 概要

各コレクションにデータが存在しない場合の適切なUIデザイン・挙動を実装する。

### 現状

- テスト環境ではデータがある状態で検証している
- データがない場合のUIデザインが未確認

### 対応内容

- [x] **SNSアカウント未連携時の「連携済みSNS」セクション表示**
  - 空状態のデザインを実装
  - 「SNSアカウントを連携してください」等の案内を表示
  - 連携ボタンへの誘導

- [x] **PR投稿が0件の場合の表示**
  - 空状態のイラスト or メッセージを表示
  - 「PR投稿を登録してください」等の案内

- [x] **その他コレクションデータがない場合の対応**
  - 各画面・セクションで空状態のUIを設計

### 優先度

**高** - 新規ユーザーの初回体験に直結する

---

## Phase 3: SNSアカウント未連携時の制御

### 概要

SNSアカウントが一つも連携されていない場合、「PR投稿を登録」機能を利用不可にする。

### 現状

- SNSアカウント未連携でもPR投稿登録画面に遷移できてしまう
- アカウントがないのにPR投稿を登録しようとする矛盾した状態が発生しうる

### 対応内容

- [x] ダッシュボードの「PR投稿を登録」ボタンの状態制御
  - SNSアカウント未連携時はボタンを非表示
  - 空状態UIで「まずSNSアカウントを連携してください」と案内を表示
  
- [x] 直接URLアクセス時の制御
  - SNSアカウント未連携時はダッシュボードに自動リダイレクト

### 優先度

**高** - ユーザー体験とデータ整合性に関わる

---

## Phase 4: PR投稿登録フロー（ステップ2）の改善

### 概要

投稿一覧取得後の画面UIを改善し、ユーザーサポート導線を整備する。

### 現状

- 投稿一覧取得後の画面下部に「投稿を再取得」ボタンが表示されている
- 問題なくデータ取得できている場合、このボタンを押しても変化がない
- ユーザーにとって意味のない機能になっている

### 対応内容

#### 4-1. 「投稿を再取得」ボタンの削除

- [x] ステップ2画面から「投稿を再取得」ボタンと関連機能を削除

#### 4-2. サポート導線の追加

- [x] 「投稿一覧が表示されない方はこちらへご連絡ください」テキストを追加
- [x] Googleフォームへのリンクを設置
- [x] Googleフォームの作成（サポート問い合わせ用）→ 既存フォームを使用

#### 4-3. トラブルシューティング情報の追加

ユーザーがGoogleフォームに連絡する前に自己解決できるよう、ツールチップ/インフォメーションを追加する。

表示する情報例：
- 「正しく連携できていない可能性があります。SNSアカウントを再連携してください」
- 「アカウント連携時に必要な設定（プロアカウント設定など）が漏れている可能性があります」
- 「連携するアカウントにビジネスアカウントまたはクリエイターアカウントの設定が必要です」

- [x] インフォメーションアイコン（ℹ️）の追加
- [x] クリック/タップでツールチップまたはモーダルを表示
- [x] トラブルシューティングガイドの内容作成

### 優先度

**中** - ユーザーサポート効率化に寄与

---

## Phase 5: 投稿一覧フィルタリング機能

### 概要

PR投稿登録フローの「投稿選択」画面で、投稿から7日経過していない投稿のみを表示する。

### 背景

このアプリは投稿から7日目の数値データを取得するもの。7日以上経過した投稿を登録しても意味がないため、表示対象から除外する。

### 時間判定ロジック

- 7日前の **00:00:00** 以降の投稿を表示対象とする
- 例：現在が **12月12日 23:59** の場合
  - 表示対象：**12月5日 00:00:00** 以降の投稿
  - 表示対象外：**12月4日 23:59:59** 以前の投稿

### 対応内容

- [ ] 投稿一覧取得APIのフィルタリングロジック追加
- [ ] フロントエンドでの表示フィルタリング（バックエンドと二重チェック）
- [ ] 「7日以上経過した投稿は表示されません」の説明テキスト追加

### 優先度

**中** - データの整合性と適切なユーザー体験

---

## Phase 6: Instagramアクセストークン自動更新機能

### 概要

連携済みのInstagramアカウントのアクセストークンを定期的に自動更新するバッチ処理を実装する。

### 背景

Instagram Graph APIのアクセストークンには有効期限があり、定期的な更新が必要。ユーザーに再連携を求めることなく、バックグラウンドで自動更新することでユーザー体験を向上させる。

### 技術構成

- **GCP Cloud Scheduler**: トークン更新処理のスケジュール管理
- **GCP Cloud Functions**: 実際のトークン更新処理
- **Firestore**: 更新されたトークンの保存先

### 対応内容

#### 6-1. Cloud Functions の実装

- [ ] アクセストークン更新関数の作成
- [ ] Instagram Graph API のトークンリフレッシュ処理
- [ ] 更新されたトークンを Firestore に保存する処理
- [ ] エラーハンドリング（更新失敗時の通知等）

#### 6-2. Cloud Scheduler の設定

- [ ] トークン更新バッチのスケジュール設定
- [ ] 実行頻度の決定（トークン有効期限に基づく）

#### 6-3. Terraform での IaC 管理

- [ ] Cloud Scheduler リソースの定義
- [ ] Cloud Functions のトリガー設定
- [ ] 必要な IAM 権限の設定

#### 6-4. 更新失敗時の対応

- [ ] 更新失敗時のユーザー通知（メール or アプリ内通知）
- [ ] 再連携を促すUI表示

### 優先度

**高** - Phase 7（数値データ取得）の前提条件となる

### ⚠️ 検討事項

> **トークン更新タイミング**
> 
> Instagram長期アクセストークンの有効期限は約60日。
> 期限切れ前に余裕をもって更新する必要がある。
> 
> **確認ポイント:**
> - 更新頻度（例：30日ごと、45日ごと等）
> - 更新失敗時のリトライ回数と間隔
> - 複数回失敗した場合のユーザー通知方法

---

## Phase 7: バッチ処理による数値データ取得機能

### 概要

投稿から7日後の数値データを自動取得するバッチ処理を実装する。

### 技術構成

- **GCP Cloud Scheduler**: バッチ処理のスケジュール管理
- **GCP Cloud Functions**: 実際のデータ取得処理
- **Firestore `prPosts` コレクション**: 取得した数値データの格納先

### 対応内容

#### 7-1. Cloud Functions の実装

- [x] PR投稿の数値データ取得関数の作成
- [x] SNS API（Instagram API等）からのデータ取得処理
- [x] 取得データを `prPosts` コレクションに格納する処理
- [ ] エラーハンドリング・リトライロジック（後続の開発で対応）

#### 7-2. Cloud Scheduler の設定

- [x] バッチ処理のスケジュール設定（毎日23:00 JST）
- [x] 実行タイミングの決定：投稿日から7日目の23:00 JST

#### 7-3. Terraform での IaC 管理

- [x] Cloud Scheduler リソースの定義
- [x] Pub/Sub トピック・サブスクリプションの定義
- [x] Cloud Functions のトリガー設定（Pub/Subトリガー）
- [x] 必要な IAM 権限の設定

#### 7-4. データモデルの拡張

- [x] `prPosts` コレクションに数値データフィールドを追加
  - ig_reels_avg_watch_time（リールの平均視聴時間）
  - ig_reels_video_view_total_time（リールの総視聴時間）
  - reach（リーチ数）
  - saved（保存数）
  - views（再生数）
  - likes（いいね数）
  - comments（コメント数）
  - dataFetchedAt（データ取得日時）

### 優先度

**高**（ただし他の機能が安定してから着手） - コア機能

### ⚠️ 注意事項

> **Phase 6 との依存関係について**
> 
> Phase 7（バッチ処理）は実装済みですが、Phase 6（トークン自動更新）は未実装です。
> このため、現在の構成では**Instagramアクセストークンの期限（60日）を過ぎると、
> Phase 7 のバッチ処理がトークン期限切れエラーで失敗**します。
> 
> Phase 6 の実装が完了するまでは、トークン期限切れの問題は許容する方針です。

### ✅ 実装済み仕様

> **バッチ処理のタイミング**
> 
> - **実行時刻**: 毎日 23:00 JST
> - **対象投稿**: 投稿日（JST基準）から7日目に該当する投稿
>   - 例：12月5日に投稿された投稿 → 12月12日 23:00のバッチで処理
> 
> **処理フロー**:
> 1. Cloud Scheduler → Pub/Sub → Cloud Functions
> 2. 対象投稿を1件ずつ処理（API負荷分散のため）
> 3. 残りの投稿は同じPub/Subにパブリッシュして再帰的に処理

---

## 検討事項・課題一覧

### 🔴 事業部確認が必要な事項

| No. | 項目 | 詳細 | ステータス |
|-----|------|------|-----------|
| 1 | バッチ処理タイミング | 投稿から7日後の具体的な取得時刻 | ✅ 完了（毎日23:00 JST） |
| 2 | 時間の基準 | UTC or JST のどちらを基準とするか | ✅ 完了（JST基準） |
| 3 | Googleフォーム | サポート問い合わせ用フォームの内容・項目 | ✅ 完了 |

### 🟡 技術的検討事項

| No. | 項目 | 詳細 | ステータス |
|-----|------|------|-----------|
| 1 | API レート制限 | Instagram API等のレート制限を考慮したバッチ設計 | 未検討 |
| 2 | リトライ戦略 | データ取得失敗時のリトライ方針 | 未検討 |
| 3 | 監視・アラート | バッチ処理の成否監視、エラー通知 | 未検討 |
| 4 | データ取得失敗時のUI | 7日後に数値取得できなかった場合の表示 | 未検討 |
| 5 | トークン更新頻度 | Instagramアクセストークンの更新タイミング（30日/45日等） | 未検討 |
| 6 | トークン更新失敗時の通知 | ユーザーへの通知方法（メール/アプリ内） | 未検討 |

### 🟢 確認済み事項

| No. | 項目 | 決定内容 |
|-----|------|----------|
| 1 | 投稿フィルタリング | 7日前の00:00:00以降の投稿を表示対象とする |
| 2 | 数値データ格納先 | `prPosts` コレクション |
| 3 | バッチ処理インフラ | GCP Cloud Scheduler + Cloud Functions |
| 4 | トークン更新インフラ | GCP Cloud Scheduler + Cloud Functions |

---

## 開発優先順位サマリー

```
┌─────────────────────────────────────────────────────────────┐
│  Phase 1: デザイン統一                     [高] [基盤]      │
│  └─ UI基盤を整える                                          │
├─────────────────────────────────────────────────────────────┤
│  Phase 2: データ未存在時のUI対応           [高] [UX]        │
│  └─ 新規ユーザー体験の向上                                  │
├─────────────────────────────────────────────────────────────┤
│  Phase 3: SNSアカウント未連携時の制御      [高] [UX/整合性] │
│  └─ 矛盾状態の防止                                          │
├─────────────────────────────────────────────────────────────┤
│  Phase 4: PR投稿登録フロー改善             [中] [UX]        │
│  └─ サポート導線の整備                                      │
├─────────────────────────────────────────────────────────────┤
│  Phase 5: 投稿一覧フィルタリング           [中] [機能]      │
│  └─ 7日以内の投稿のみ表示                                   │
├─────────────────────────────────────────────────────────────┤
│  Phase 6: アクセストークン自動更新         [高] [インフラ]  │
│  └─ Instagram連携の維持                                     │
├─────────────────────────────────────────────────────────────┤
│  Phase 7: バッチ処理（数値データ取得）     [高] [コア機能]  │
│  └─ ※ Phase 6完了後 & 事業部確認後に着手                   │
└─────────────────────────────────────────────────────────────┘
```

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2025-12-23 | 初版作成 |
| 2025-12-23 | Phase 6（Instagramアクセストークン自動更新機能）を追加 |
| 2025-12-24 | Phase 1（デザイン統一）完了 |
| 2025-12-24 | Phase 2（データ未存在時のUI対応）完了 |
| 2025-12-24 | Phase 3（SNSアカウント未連携時の制御）完了 |
| 2025-12-24 | Phase 4（PR投稿登録フロー改善）完了 |
| 2025-12-24 | Phase 7（バッチ処理による数値データ取得機能）実装完了 |
| 2025-12-24 | ドキュメント整合性の修正（日付、Phase 6/7 の依存関係注記追加） |

